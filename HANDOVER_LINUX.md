# SpendPal — Linux Development Handover Guide

## 1. Clone & Setup

```bash
# Clone
git clone https://github.com/blrtechpub-droid/spendpal.git
cd spendpal

# Install Flutter (if not installed)
# https://docs.flutter.dev/get-started/install/linux/android
# Required: Flutter 3.35.4+ / Dart 3.9.2+
flutter --version

# Get dependencies
flutter pub get
```

## 2. Files NOT in Git (You Must Create/Copy These)

The `.gitignore` excludes several sensitive files. You need to recreate or copy them from your Mac.

### a) Firebase Config Files

| File | How to get it |
|------|---------------|
| `android/app/google-services.json` | Firebase Console → Project Settings → Android app → Download |
| `ios/Runner/GoogleService-Info.plist` | Firebase Console → Project Settings → iOS app → Download |
| `.firebaserc` | Run `firebase use spendpal-app-blrtechpub` or create manually (see below) |

**Create `.firebaserc` manually:**
```json
{
  "projects": {
    "default": "spendpal-app-blrtechpub"
  }
}
```

> `lib/firebase_options.dart` IS committed (contains only public config). No action needed.

### b) Android Signing (Only needed for release builds)

| File | Location | Notes |
|------|----------|-------|
| `android/key.properties` | Excluded from git | Contains keystore paths and passwords |
| Upload keystore (`.jks`) | Referenced in key.properties | Copy from Mac or generate new |

**Create `android/key.properties`:**
```properties
storePassword=YOUR_PASSWORD
keyPassword=YOUR_PASSWORD
keyAlias=upload
storeFile=/absolute/path/to/your/upload-keystore.jks
```

> For debug builds, you don't need signing config. Only required for `flutter build appbundle --release`.

### c) `android/local.properties`

Auto-generated by Flutter on first build, but if needed:
```properties
sdk.dir=/home/YOUR_USER/Android/Sdk
flutter.sdk=/home/YOUR_USER/flutter
```

## 3. Firebase CLI Setup

```bash
# Install Firebase CLI
npm install -g firebase-tools
# OR
curl -sL https://firebase.google.com/downloads/cli/linux/amd64 -o firebase && chmod +x firebase

# Login
firebase login

# Set project
firebase use spendpal-app-blrtechpub
```

## 4. Android SDK / Emulator on Linux

```bash
# Install Android Studio or cmdline-tools
# https://developer.android.com/studio

# After install, ensure these are in your PATH (~/.bashrc or ~/.zshrc):
export ANDROID_HOME=$HOME/Android/Sdk
export PATH=$PATH:$ANDROID_HOME/emulator
export PATH=$PATH:$ANDROID_HOME/platform-tools
export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin

# Accept licenses
flutter doctor --android-licenses

# Verify everything
flutter doctor -v
```

**Required by this project:**
- Android SDK (compileSdk, minSdk, targetSdk managed by Flutter)
- Java 11+ (Kotlin JVM target is 11)
- Gradle (bundled with project via `android/gradle/wrapper/`)

## 5. Running the App

```bash
# List available devices
flutter devices

# Run on connected Android device or emulator
flutter run

# Run in release mode
flutter run --release

# Build APK
flutter build apk

# Build App Bundle (Play Store)
flutter build appbundle
```

## 6. Current State of the Codebase

### Latest Commit on `main`
```
bd5e004 feat: Add scan history, investment journey docs, and minor fixes
```

### Uncommitted Work (will be in the next commit you pull)
The instrument cache feature was just implemented. These are the changed/new files:

**New files:**
- `lib/models/instrument_cache_item.dart` — Cache model for MF/Stock/ETF instruments
- `lib/services/instrument_cache_service.dart` — Singleton service: fetches, caches, and searches ~13K instruments

**Modified files:**
- `lib/services/local_db_service.dart` — DB version 4→5, added `instrument_cache` and `cache_metadata` tables
- `lib/screens/investments/add_asset_screen.dart` — Autocomplete now searches from SQLite cache with debounce + auto-fill

### What the Instrument Cache Does
- On first use of Add Asset screen, fetches ~10K MF schemes from `api.mfapi.in` and ~2.8K NSE stocks from `nsearchives.nseindia.com`
- Stores in local SQLite with 7-day TTL
- Provides instant autocomplete with starts-with ranking
- Auto-fills symbol (for stocks) and scheme code (for MFs) on selection
- Falls back to static popular lists if cache unavailable

## 7. Project Architecture Quick Reference

```
lib/
├── models/              # Data models (Firestore + SQLite)
├── screens/             # UI screens organized by feature
│   ├── investments/     # Investment tracker (add_asset_screen.dart is here)
│   ├── groups/          # Group expense splitting
│   ├── friends/         # Friend management
│   ├── expense/         # Expense entry
│   └── ...
├── services/            # Business logic & API services
│   ├── local_db_service.dart      # SQLite (transactions, patterns, instrument cache)
│   ├── instrument_cache_service.dart  # MF/Stock cache (NEW)
│   ├── balance_service.dart       # Expense balance calculations
│   ├── auth_service.dart          # Firebase Auth
│   └── ...
├── widgets/             # Reusable UI components
└── main.dart            # App entry, routes, Firebase init
```

**Key patterns:**
- Firebase Auth (Google Sign-In) + Firestore for shared data
- SQLite (`sqflite`) for local-only data (transactions, instrument cache)
- `StreamBuilder` for real-time Firestore updates
- Named routes defined in `main.dart`

## 8. Key Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| `firebase_core` | ^4.1.1 | Firebase initialization |
| `firebase_auth` | ^6.1.0 | Authentication |
| `cloud_firestore` | ^6.0.2 | Cloud database |
| `sqflite` | ^2.3.3+1 | Local SQLite |
| `http` | ^1.2.2 | HTTP client (used by instrument cache) |
| `csv` | ^6.0.0 | CSV parsing (NSE stock data, Splitwise import) |
| `fl_chart` | ^0.69.0 | Charts/analytics |
| `provider` | ^6.1.2 | State management |

Full list in `pubspec.yaml`. Run `flutter pub get` after cloning.

## 9. Common Issues on Linux

| Issue | Fix |
|-------|-----|
| `flutter doctor` shows Chrome missing | Install Chrome or use `--no-web` |
| KVM not enabled (emulator slow) | `sudo apt install qemu-kvm` and add user to kvm group |
| `google-services.json` missing | Download from Firebase Console (see section 2a) |
| Gradle build fails with Java error | Ensure Java 11+: `java --version` |
| `flutter pub get` fails on `telephony` | This package is Android-only; works fine on Linux host for Android builds |
| NSE CSV fetch returns 403 | The service sets User-Agent header; should work. If blocked, cache falls back to static lists |

## 10. Development Workflow

```bash
# Start a session
flutter pub get
flutter run

# Analyze code
flutter analyze

# Run tests
flutter test

# Before committing
flutter analyze && flutter test
```

## 11. Next Steps / Pending Work

Refer to `.claude/STATUS.md` (committed) and `CLAUDE.md` for full context. Key areas:

- **Test the instrument cache** on a real device (verify MF API + NSE CSV fetch)
- **AuthService** methods are still placeholders in some areas
- **QR code scanning** route referenced but not fully implemented
- **iOS build** not yet configured for release
- **Play Store** — internal testing track is set up (see `.claude/GOOGLE_PLAY_CONSOLE_GUIDE.md`)

## 12. Transferring Secrets from Mac

On your Mac, before switching:
```bash
# Copy these files to a secure USB or encrypted transfer:
cp android/app/google-services.json /secure-location/
cp android/key.properties /secure-location/
cp path/to/upload-keystore.jks /secure-location/
# If you have iOS files:
cp ios/Runner/GoogleService-Info.plist /secure-location/
```

On Linux, place them back:
```bash
cp /secure-location/google-services.json android/app/
cp /secure-location/key.properties android/
cp /secure-location/upload-keystore.jks android/app/
```

Never commit these files — they're in `.gitignore`.
